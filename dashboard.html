<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOBIX EMPIRE - –ü–∞–Ω–µ–ª—å</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .dashboard { 
            background: white; 
            padding: 40px; 
            border-radius: 15px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        h1 { color: #8a2be2; margin-bottom: 20px; text-align: center; }
        .user-info { 
            background: #f5f5f5; 
            padding: 20px; 
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #8a2be2;
        }
        .user-info p {
            margin: 10px 0;
            padding: 8px;
            background: white;
            border-radius: 5px;
        }
        .logout-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
            width: 100%;
            transition: background 0.3s;
        }
        .logout-btn:hover { background: #ff3742; }
        .logout-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .error { 
            background: #ffebee; 
            color: #c62828; 
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border: 2px solid #ffcdd2;
        }
        .success { 
            background: #e8f5e9; 
            color: #2e7d32; 
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border: 2px solid #c8e6c9;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .role-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .role-admin { background: #ff9800; color: white; }
        .role-user { background: #2196f3; color: white; }
        .role-owner { background: #9c27b0; color: white; }
    </style>
</head>
<body>
    <div class="dashboard">
        <h1>üå∏ BOBIX EMPIRE - –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
        
        <div id="dashboard-error" class="error"></div>
        <div id="dashboard-success" class="success"></div>
        
        <div class="user-info">
            <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:</h2>
            <p><strong>ID:</strong> <span id="user-id" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
            <p><strong>–ò–º—è:</strong> <span id="user-name" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
            <p><strong>Email:</strong> <span id="user-email" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
            <p><strong>–†–æ–ª—å:</strong> <span id="user-role" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
        </div>
        
        <div id="admin-panel" style="display: none; margin-bottom: 30px; padding: 20px; background: #fff3e0; border-radius: 10px;">
            <h2 style="color: #ff9800;">üîß –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
            <p>–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –∏ –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤.</p>
        </div>
        
        <div id="owner-panel" style="display: none; margin-bottom: 30px; padding: 20px; background: #f3e5f5; border-radius: 10px;">
            <h2 style="color: #9c27b0;">üëë –ü–∞–Ω–µ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–∞</h2>
            <p>–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤.</p>
        </div>
        
        <button class="logout-btn" id="btn-logout">–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</button>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase - –¢–ï –ñ–ï –ö–õ–Æ–ß–ò!
        const SUPABASE_URL = 'https://dkyqegxdcerlqnfvodjd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRreXFlZ3hkY2VybHFuZnZvZGpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTc2NzQsImV4cCI6MjA4NTYzMzY3NH0.n6KO-IQMZboeOMCnJQw6gAs8DdWFDZpevAOWBQrxFWA';
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let isLoggingOut = false;
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(message, type = 'error') {
            const element = type === 'error' ? 
                document.getElementById('dashboard-error') : 
                document.getElementById('dashboard-success');
            
            if (element) {
                element.textContent = message;
                element.className = type === 'error' ? 'error' : 'success';
                element.style.display = 'block';
                
                // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                if (type === 'success') {
                    setTimeout(() => {
                        element.style.display = 'none';
                    }, 3000);
                }
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function checkAuth() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.error('Session error:', error);
                    showMessage('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Å—Å–∏–∏', 'error');
                    return null;
                }
                
                if (!session) {
                    console.log('No session found, redirecting to login');
                    // –î–∞–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–º
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 500);
                    return null;
                }
                
                console.log('User authenticated:', session.user.email);
                return session.user;
                
            } catch (error) {
                console.error('Auth check failed:', error);
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'error');
                return null;
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserData() {
            console.log('Loading user data...');
            
            const user = await checkAuth();
            if (!user) return;
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ sessionStorage (–±—ã—Å—Ç—Ä—ã–π –ø–æ–∫–∞–∑)
            const userId = sessionStorage.getItem('user_id');
            const username = sessionStorage.getItem('user_username') || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            const userEmail = sessionStorage.getItem('user_email') || user.email;
            const userRole = sessionStorage.getItem('user_role') || 'user';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ sessionStorage
            document.getElementById('user-id').textContent = userId ? 
                userId.substring(0, 8) + '...' : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            document.getElementById('user-id').className = '';
            
            document.getElementById('user-name').textContent = username;
            document.getElementById('user-name').className = '';
            
            document.getElementById('user-email').textContent = userEmail;
            document.getElementById('user-email').className = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–æ–ª—å —Å –±–µ–π–¥–∂–µ–º
            const roleElement = document.getElementById('user-role');
            roleElement.textContent = userRole;
            roleElement.className = `role-badge role-${userRole}`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–∞–Ω–µ–ª–∏
            if (userRole === 'admin' || userRole === 'owner') {
                document.getElementById('admin-panel').style.display = 'block';
            }
            if (userRole === 'owner') {
                document.getElementById('owner-panel').style.display = 'block';
            }
            
            // –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
            if (sessionStorage.getItem('is_test_account') === 'true') {
                showMessage('‚ö†Ô∏è –í—ã –≤–æ—à–ª–∏ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã.', 'error');
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã
            try {
                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('username, role')
                    .eq('id', user.id)
                    .maybeSingle();
                
                if (!error && profile) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –æ–Ω–∏ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è
                    if (profile.username && profile.username !== username) {
                        document.getElementById('user-name').textContent = profile.username;
                        sessionStorage.setItem('user_username', profile.username);
                    }
                    
                    if (profile.role && profile.role !== userRole) {
                        const roleElement = document.getElementById('user-role');
                        roleElement.textContent = profile.role;
                        roleElement.className = `role-badge role-${profile.role}`;
                        sessionStorage.setItem('user_role', profile.role);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª–∏
                        document.getElementById('admin-panel').style.display = 'none';
                        document.getElementById('owner-panel').style.display = 'none';
                        
                        if (profile.role === 'admin' || profile.role === 'owner') {
                            document.getElementById('admin-panel').style.display = 'block';
                        }
                        if (profile.role === 'owner') {
                            document.getElementById('owner-panel').style.display = 'block';
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading profile from DB:', error);
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
            }
            
            console.log('User data loaded successfully');
        }
        
        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        async function handleLogout() {
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
            if (isLoggingOut) return;
            
            isLoggingOut = true;
            
            const logoutBtn = document.getElementById('btn-logout');
            const originalText = logoutBtn.textContent;
            logoutBtn.textContent = '–í—ã—Ö–æ–¥...';
            logoutBtn.disabled = true;
            
            try {
                console.log('Logging out...');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                showMessage('–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã...', 'info');
                
                // –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç, –ø—Ä–æ—Å—Ç–æ –æ—á–∏—â–∞–µ–º sessionStorage
                if (sessionStorage.getItem('is_test_account') === 'true') {
                    console.log('Test account logout');
                    sessionStorage.clear();
                    localStorage.clear();
                    
                    showMessage('‚úÖ –í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'success');
                    
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                    return;
                }
                
                // –†–µ–∞–ª—å–Ω—ã–π –≤—ã—Ö–æ–¥ –∏–∑ Supabase
                const { error } = await supabase.auth.signOut();
                
                if (error) {
                    console.error('Logout error:', error);
                    showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ: ' + error.message, 'error');
                    
                    // –í—Å–µ —Ä–∞–≤–Ω–æ –æ—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    sessionStorage.clear();
                    localStorage.clear();
                    
                    // –ò –ø—Ä–æ–±—É–µ–º —Ä–µ–¥–∏—Ä–µ–∫—Ç
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    return;
                }
                
                // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                sessionStorage.clear();
                localStorage.clear();
                
                console.log('Logout successful');
                showMessage('‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'success');
                
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
                
            } catch (error) {
                console.error('Logout exception:', error);
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ', 'error');
                
                // –í—Å–µ —Ä–∞–≤–Ω–æ –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º
                sessionStorage.clear();
                localStorage.clear();
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                
            } finally {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
                setTimeout(() => {
                    logoutBtn.textContent = originalText;
                    logoutBtn.disabled = false;
                    isLoggingOut = false;
                }, 3000);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Dashboard initializing...');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await loadUserData();
            
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∞
            const logoutBtn = document.getElementById('btn-logout');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            window.addEventListener('beforeunload', () => {
                console.log('Page unloading...');
            });
            
            console.log('Dashboard initialized');
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –≤ –±—Ä–∞—É–∑–µ—Ä–µ
        window.addEventListener('popstate', () => {
            console.log('Back button pressed');
        });
    </script>
</body>
</html>
